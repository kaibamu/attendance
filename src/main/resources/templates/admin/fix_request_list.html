<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>修正依頼一覧（未処理）</title>
  <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>

<div th:replace="fragments/header :: appHeader('修正依頼一覧（未処理）')"></div>
<div th:replace="fragments/layout :: page(~{::content})">
  <th:block th:fragment="content">

    <div class="action-row" style="margin-top: 12px;">

      <a th:href="@{/admin/dashboard}" class="button secondary">
        ← 管理者ダッシュボードへ戻る
      </a>

      <a th:href="@{/admin/fix-requests/all}" class="button primary btn-with-badge">
        全件を見る
        <span class="badge-count"
              th:if="${pendingFixCount != null and pendingFixCount > 0}"
              th:text="${pendingFixCount}"></span>
      </a>

      <form th:action="@{/logout}" method="post" style="margin:0;">
        <button type="submit" class="button danger">ログアウト</button>
      </form>

    </div>

    <!-- メッセージ -->
    <div th:if="${param.error}" style="margin:8px 0; color:#c62828; font-weight:700;">
      <span th:if="${param.error[0] == 'alreadyProcessed'}">
        その申請はすでに処理済みです（画面を更新してください）。
      </span>
    </div>

    <div th:if="${param.success}" style="margin:8px 0; color:#2e7d32; font-weight:700;">
      <span th:if="${param.success[0] == 'approved'}">承認しました。</span>
      <span th:if="${param.success[0] == 'rejected'}">却下しました。</span>
    </div>

    <div class="table-responsive">
      <table class="attendance-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>申請者</th>
            <th>対象日</th>
            <th>理由</th>
            <th>状態</th>
            <th>操作</th>
          </tr>
        </thead>

        <tbody>
          <tr th:if="${#lists.isEmpty(fixRequests)}">
            <td colspan="6">未処理の修正依頼はありません</td>
          </tr>

          <tr th:each="req : ${fixRequests}">
            <td th:text="${req.id}"></td>
            <td th:text="${req.user != null ? req.user.username : '-'}"></td>
            <td th:text="${req.attendance != null ? req.attendance.recordDate : '-'}"></td>
            <td th:text="${req.reason}"></td>
            <td>
              <span th:text="${req.status == 'pending' ? '申請中' : (req.status == 'approved' ? '承認済み' : (req.status == 'rejected' ? '却下' : req.status))}"></span>
            </td>

            <!-- 操作（未処理だけ出る画面なのでボタンのみ） -->
            <td style="text-align:center;">
              <div style="display:flex; gap:10px; justify-content:center; align-items:center;">

                <form th:action="@{/admin/fix-requests/{id}/approve(id=${req.id})}"
                      method="post" style="margin:0;">
                  <button type="submit"
                          class="button primary"
                          onclick="return confirm('この修正依頼を承認します。よろしいですか？');">
                    承認
                  </button>
                </form>

                <form th:action="@{/admin/fix-requests/{id}/reject(id=${req.id})}"
                      method="post" style="margin:0;">
                  <button type="submit"
                          class="button danger"
                          onclick="return confirm('この修正依頼を却下します。よろしいですか？');">
                    却下
                  </button>
                </form>

              </div>
            </td>
          </tr>

        </tbody>
      </table>
    </div>

  </th:block>
</div>

</body>
</html>