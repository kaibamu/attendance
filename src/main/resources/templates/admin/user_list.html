<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ユーザー一覧（管理者）</title>
  <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<div th:if="${success}" style="background:#e6ffed; border:1px solid #b7eb8f; padding:10px; margin:10px 0;">
  <span th:text="${success}"></span>
</div>

<div th:if="${error}" style="background:#fff1f0; border:1px solid #ffa39e; padding:10px; margin:10px 0;">
  <span th:text="${error}"></span>
</div>
<body>
  <div class="container">
    <h1>ユーザー一覧</h1>

    <!-- ✅ フラッシュメッセージ（成功/エラー） -->
    <div style="margin: 12px 0;">
      <p th:if="${error}" class="error-message" th:text="${error}"></p>
      <p th:if="${success}" class="success-message" th:text="${success}"></p>
    </div>

	<div class="button-group" style="margin: 12px 0 18px;">
	  <a th:href="@{/admin/users/new}" class="button primary">ユーザー登録</a>
	  <a th:href="@{/admin/audit-logs}" class="button secondary">監査ログ</a>
	  <a th:href="@{/admin/dashboard}" class="button secondary">管理者ダッシュボードへ戻る</a>
	</div>

    <!-- 検索 + 並び替え（条件保持） -->
    <div style="margin: 10px 0 16px; display:flex; gap:12px; flex-wrap:wrap; align-items:center;">

      <!-- 検索 -->
      <form th:action="@{/admin/users}" method="get"
            style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">

        <input type="text" name="q" placeholder="社員番号 or ユーザー名で検索"
               th:value="${q}" style="min-width:260px; padding:8px;">

        <input type="hidden" name="sort" th:value="${sort}">
        <!-- ✅ ページング条件も保持 -->
        <input type="hidden" name="page" th:value="${page != null ? page.number : 0}">
        <input type="hidden" name="size" th:value="${page != null ? page.size : 10}">

        <button type="submit" class="button primary">検索</button>

        <!-- クリア（sort + page/size保持、qは外す） -->
        <a th:href="@{/admin/users(sort=${sort}, page=${page != null ? page.number : 0}, size=${page != null ? page.size : 10})}"
           class="button secondary">クリア</a>
      </form>

      <!-- 並び替え -->
      <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
        <span style="font-size:0.95em;">並び替え:</span>

		<a class="button secondary"
		   th:href="@{/admin/users(sort='id', q=${q})}"
		   th:classappend="${sort}=='id' ? ' primary' : ''">
		  登録順
		</a>

        <a class="button secondary"
           th:href="@{/admin/users(sort='emp', q=${q}, page=${page != null ? page.number : 0}, size=${page != null ? page.size : 10})}"
           th:classappend="${sort}=='emp' ? ' primary' : ''">
          社員番号
        </a>
      </div>
    </div>

    <div class="table-responsive">
      <table class="attendance-table">
        <thead>
          <tr>
            <th>社員番号</th>
            <th>ユーザー名</th>
            <th>権限</th>
            <th>状態</th>
            <th style="width: 240px;">操作</th>
          </tr>
        </thead>

        <tbody>
          <tr th:each="u : ${users}">
            <td th:text="${u.employeeNo}">-</td>
            <td th:text="${u.username}">-</td>
            <td th:text="${u.role}">-</td>
            <td th:text="${u.enabled} ? '有効' : '停止'">-</td>

            <!-- ✅ 操作ボタン（見た目固定：上段2つ＋下段1つ） -->
            <td>
              <!-- 上段：編集 + 停止/再開 -->
              <div style="display:flex; gap:8px; margin-bottom:6px; align-items:center;">
                <a class="button secondary"
                   th:href="@{/admin/users/{id}/edit(id=${u.id}, sort=${sort}, q=${q}, page=${page.number}, size=${page.size})}">
                  編集
                </a>

                <form th:action="@{/admin/users/{id}/toggle(id=${u.id})}" method="post" style="margin:0;">
                  <input type="hidden" name="sort" th:value="${sort}">
                  <input type="hidden" name="q" th:value="${q}">
                  <input type="hidden" name="page" th:value="${page.number}">
                  <input type="hidden" name="size" th:value="${page.size}">
                  <button type="submit" class="button secondary"
                          th:text="${u.enabled} ? '停止' : '再開'">
                    停止
                  </button>
                </form>
              </div>

              <!-- 下段：PW初期化 -->
              <div>
                <form th:action="@{/admin/users/{id}/reset-password(id=${u.id})}"
                      method="post"
                      style="margin:0;"
                      onsubmit="return confirm('このユーザーのパスワードを初期化します。よろしいですか？');">

                  <input type="hidden" name="sort" th:value="${sort}">
                  <input type="hidden" name="q" th:value="${q}">
                  <input type="hidden" name="page" th:value="${page.number}">
                  <input type="hidden" name="size" th:value="${page.size}">

                  <button type="submit" class="button secondary">PW初期化</button>
                </form>
              </div>
            </td>
          </tr>

          <tr th:if="${#lists.isEmpty(users)}">
            <td colspan="5">ユーザーがいません。</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div style="margin-top:14px; font-size:0.95em; color:#555;">
      ※ユーザーは削除せず「停止/再開」で管理します（勤怠履歴の整合性を保つため）。
    </div>

    <!-- ページング（条件保持） -->
    <div th:if="${page != null}"
         style="margin-top:14px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">

      <a class="button secondary"
         th:if="${page.hasPrevious()}"
         th:href="@{/admin/users(page=${page.number - 1}, size=${page.size}, sort=${sort}, q=${q})}">
        ← 前へ
      </a>

      <span style="font-size:0.95em;">
        <span th:text="${page.number + 1}">1</span> /
        <span th:text="${page.totalPages}">1</span>
        （全<span th:text="${page.totalElements}">0</span>件）
      </span>

      <a class="button secondary"
         th:if="${page.hasNext()}"
         th:href="@{/admin/users(page=${page.number + 1}, size=${page.size}, sort=${sort}, q=${q})}">
        次へ →
      </a>
    </div>

  </div>
</body>
</html>