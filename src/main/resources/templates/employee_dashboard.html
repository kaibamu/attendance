<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <title>社員ダッシュボード</title>
  <link rel="stylesheet" th:href="@{/css/style.css}">
</head>

<body>

  <div th:replace="fragments/header :: appHeader('社員ダッシュボード')"></div>

  <div th:replace="fragments/layout :: page(~{::content})">

    <th:block th:fragment="content">

      <div class="card">
        <h2>打刻</h2>

        <div class="punch-grid">

          <form id="checkInForm" th:action="@{/attendance/punch}" method="post" class="punch-item">
            <input type="hidden" name="type" value="check_in">
            <button type="button" onclick="submitNormal('checkInForm')">出勤</button>
          </form>

          <form id="checkInDirectForm" th:action="@{/attendance/punch}" method="post" class="punch-item">
            <input type="hidden" name="type" value="check_in_direct">
            <input type="hidden" name="latitude">
            <input type="hidden" name="longitude">
            <button type="button" onclick="submitWithLocation('checkInDirectForm')">直行出勤</button>
          </form>

          <form id="breakStartForm" th:action="@{/attendance/punch}" method="post" class="punch-item">
            <input type="hidden" name="type" value="break_start">
            <button type="button" onclick="submitNormal('breakStartForm')">休憩開始</button>
          </form>

          <form id="breakEndForm" th:action="@{/attendance/punch}" method="post" class="punch-item">
            <input type="hidden" name="type" value="break_end">
            <button type="button" onclick="submitNormal('breakEndForm')">休憩終了</button>
          </form>

          <form id="checkOutForm" th:action="@{/attendance/punch}" method="post" class="punch-item">
            <input type="hidden" name="type" value="check_out">
            <button type="button" onclick="submitNormal('checkOutForm')">退勤</button>
          </form>

          <form id="checkOutDirectForm" th:action="@{/attendance/punch}" method="post" class="punch-item">
            <input type="hidden" name="type" value="check_out_direct">
            <input type="hidden" name="latitude">
            <input type="hidden" name="longitude">
            <button type="button" onclick="submitWithLocation('checkOutDirectForm')">直帰退勤</button>
          </form>

        </div>
      </div>

      <div class="card">
        <h2>あなたの勤怠履歴</h2>

        <div class="table-responsive">
        <table class="attendance-table">
          <thead>
          <tr>
            <th class="col-date">日付</th>
            <th class="col-time">出勤</th>
            <th class="col-time">退勤</th>
            <th class="col-time">休憩開始</th>
            <th class="col-time">休憩終了</th>
            <th class="col-type">勤務区分</th>
            <th class="col-place">場所</th>
            <th class="col-status">状態</th>
          </tr>
          </thead>

          <tbody>
          <tr th:each="record : ${attendanceRecords}">
            <td class="col-date" th:text="${record.recordDate}"></td>
            <td class="col-time" th:text="${record.checkInTime != null ? record.checkInTime : '-'}"></td>
            <td class="col-time" th:text="${record.checkOutTime != null ? record.checkOutTime : '-'}"></td>
            <td class="col-time" th:text="${record.breakStartTime != null ? record.breakStartTime : '-'}"></td>
            <td class="col-time" th:text="${record.breakEndTime != null ? record.breakEndTime : '-'}"></td>
            <td class="col-type" th:text="${record.workType}"></td>
            <td class="col-place" th:text="${record.location != null ? record.location : '-'}"></td>
            <td class="col-status" th:text="${record.statusLabel}"></td>
          </tr>

          <tr th:if="${#lists.isEmpty(attendanceRecords)}">
            <td colspan="8">勤怠記録がありません。</td>
          </tr>
          </tbody>
        </table>
        </div>
      </div>

      <div class="button-group">
        <a th:href="@{/attendance/history}" class="button secondary">勤怠履歴詳細</a>
      </div>

      <div class="button-group" style="margin-top:24px;">
        <form th:action="@{/logout}" method="post">
          <button type="submit" class="button danger">ログアウト</button>
        </form>
      </div>

      <script>
        function submitNormal(formId) {
          document.getElementById(formId).submit();
        }

        function submitWithLocation(formId) {
          if (!navigator.geolocation) {
            alert("このブラウザでは位置情報が使えません");
            return;
          }

          navigator.geolocation.getCurrentPosition(
            function (pos) {
              const form = document.getElementById(formId);
              form.querySelector('input[name="latitude"]').value = pos.coords.latitude;
              form.querySelector('input[name="longitude"]').value = pos.coords.longitude;
              form.submit();
            },
            function () {
              alert("位置情報の取得に失敗しました");
            },
            { enableHighAccuracy: true, timeout: 5000 }
          );
        }
      </script>

    </th:block>
  </div>

</body>
</html>
